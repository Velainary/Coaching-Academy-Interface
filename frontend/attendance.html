<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Attendance</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="nav">
    <div class="brand">EduConnect</div>
    <nav>
      <a href="index.html">Home</a>
      <a href="courses.html">Courses</a>
      <a href="instructors.html">Instructors</a>
      <a href="attendance.html">Attendance</a>
      <a href="login.html" class="nav-login">Login</a>
    </nav>
  </header>

  <main class="container">
    <h2>Attendance Sheet</h2>

    <!-- ADMIN-ONLY FORM -->
    <section class="card admin-only" style="display:none;">
      <label>Student</label>
      <select id="att-student"></select>

      <label>Course</label>
      <select id="att-course"></select>

      <label>Date</label>
      <input id="att-date" type="date">

      <label>Status</label>
      <select id="att-status">
        <option value="Present">Present</option>
        <option value="Absent">Absent</option>
      </select>

      <button id="mark-att" class="btn">Mark Attendance</button>
    </section>

    <section id="att-list" class="table-wrap"></section>
  </main>

  <footer>Â© 2025 EduConnect</footer>
  <script src="auth.js"></script>
  <script>
    async function loadStudentsAndCourses() {
      try {
        const [uRes, cRes] = await Promise.all([
          authFetch('/api/users'),
          authFetch('/api/courses')
        ]);

        const users = uRes.ok ? await uRes.json() : [];
        const courses = cRes.ok ? await cRes.json() : [];

        const studentSelect = document.getElementById('att-student');
        studentSelect.innerHTML = '';
        users
          .filter(u => u.role === 'student')
          .forEach(u => {
            studentSelect.innerHTML += `<option value="${u.id}">${u.name || u.username}</option>`;
          });

        const courseSelect = document.getElementById('att-course');
        courseSelect.innerHTML = '';
        courses.forEach(c => {
          courseSelect.innerHTML += `<option value="${c.id}">${c.title || c.name || c.subject}</option>`;
        });
      } catch (err) {
        console.error('Failed to load users/courses', err);
      }
    }

    async function loadAttendance() {
      try {
        const res = await authFetch('/api/attendance');
        const data = res.ok ? await res.json() : [];
        const wrap = document.getElementById('att-list');

        if (!Array.isArray(data) || data.length === 0) {
          wrap.innerHTML = '<p>No attendance records found.</p>';
          return;
        }

        wrap.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Student</th>
                <th>Course</th>
                <th>Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${data.map(r => `
                <tr>
                  <td>${r.student?.name || r.student_name || 'Unknown'}</td>
                  <td>${r.course?.title || r.course_name || 'Unknown'}</td>
                  <td>${r.date}</td>
                  <td>${r.status}</td>
                </tr>`).join('')}
            </tbody>
          </table>`;
      } catch (err) {
        console.error('Failed to load attendance', err);
      }
    }

    document.getElementById('mark-att').addEventListener('click', async () => {
      const user_id = document.getElementById('att-student').value;
      const course_id = document.getElementById('att-course').value;
      const date = document.getElementById('att-date').value || new Date().toISOString().slice(0,10);
      const status = document.getElementById('att-status').value;

      try {
        const res = await authFetch('/api/attendance', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ user_id, course_id, date, status })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.message || 'Failed');
        }

        alert('Attendance marked successfully!');
        loadAttendance();
      } catch (e) {
        alert('Mark failed: ' + e.message);
      }
    });

    (function init() {
      document.getElementById('att-date').value = new Date().toISOString().slice(0,10);
      enforceRoleAccess(); // from auth.js
      loadStudentsAndCourses();
      loadAttendance();
    })();
  </script>
</body>
</html>
