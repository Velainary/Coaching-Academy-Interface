<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Attendance</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="nav">
  <div class="brand">EduConnect</div>
  <nav>
    <a href="index.html">Home</a>
    <a href="courses.html">Courses</a>
    <a href="instructors.html">Instructors</a>
    <a href="attendance.html">Attendance</a>
    <a href="login.html" class="nav-login">Login</a>
  </nav>
</header>

  <main class="container">
    <h2>Attendance Sheet</h2>

    <!-- ADMIN-ONLY FORM -->
    <section class="card admin-only" style="display:none;">
      <label>Student</label>
      <select id="student-select"></select>

      <label>Course</label>
      <select id="course-select"></select>

      <label>Date</label>
      <input id="att-date" type="date" value="">

      <label>Status</label>
      <select id="att-status">
        <option value="Present">Present</option>
        <option value="Absent">Absent</option>
      </select>

      <button id="mark-att" class="btn">Mark Attendance</button>
    </section>

    <section id="att-list" class="table-wrap"></section>
  </main>

  <footer>Â© 2025 EduConnect</footer>
  <script src="auth.js"></script>
  <script>
    async function loadStudentsAndCourses(){
      const [uRes, cRes] = await Promise.all([fetch('/api/auth/users'), fetch('/api/courses')]);
      const users = uRes.ok ? await uRes.json() : [];
      const courses = cRes.ok ? await cRes.json() : [];

      const studentSelect = document.getElementById('student-select');
      studentSelect.innerHTML = '';
      users.forEach(u => {
        studentSelect.innerHTML += `<option value="${u.id}">${u.name} (${u.role})</option>`;
      });

      const courseSelect = document.getElementById('course-select');
      courseSelect.innerHTML = '';
      courses.forEach(c => courseSelect.innerHTML += `<option value="${c.id}">${c.title || c.subject}</option>`);
    }

    async function loadAttendance(){
      const res = await fetch('/api/attendance');
      const data = res.ok ? await res.json() : [];
      const wrap = document.getElementById('att-list');
      wrap.innerHTML = `<table><thead><tr><th>Student</th><th>Course</th><th>Date</th><th>Status</th></tr></thead><tbody>${
        data.map(r => `<tr><td>${r.student}</td><td>${r.course}</td><td>${r.date}</td><td>${r.status}</td></tr>`).join('')
      }</tbody></table>`;
    }

    document.getElementById('mark-att').addEventListener('click', async ()=>{
      const user_id = document.getElementById('student-select').value;
      const course_id = document.getElementById('course-select').value;
      const date = document.getElementById('att-date').value || new Date().toISOString().slice(0,10);
      const status = document.getElementById('att-status').value;
      try{
        const res = await fetch('/api/attendance', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ user_id, course_id, date, status })
        });
        if(!res.ok) throw await res.json();
        loadAttendance();
      }catch(e){ alert('Mark failed: '+(e.error||e.message||JSON.stringify(e))); }
    });

    // === INIT ===
    (function init(){
      // set default date to today
      document.getElementById('att-date').value = new Date().toISOString().slice(0,10);
      loadStudentsAndCourses();
      loadAttendance();
      enforceRoleAccess(); // from auth.js
    })();
  </script>
</body>
</html>
