<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Attendance</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="navbar">
  <div class="nav-brand">
    <span class="logo">EduConnect</span>
  </div>
  <nav class="nav-links">
    <a href="index.html">Home</a>
    <a href="courses.html">Courses</a>
    <a href="instructors.html">Instructors</a>
    <a href="attendance.html">Attendance</a>
  </nav>
  <a href="login.html" class="nav-login-btn nav-login">Login</a>
</header>

  <main class="container">
    <h2>Attendance Sheet</h2>

    <!-- TEACHER-ONLY FORM -->
    <section class="card admin-only" style="display:none;">
      <label>Student</label>
      <select id="att-student"></select>

      <label>Course</label>
      <select id="att-course"></select>

      <label>Date</label>
      <input id="att-date" type="date">

      <label>Status</label>
      <select id="att-status">
        <option value="Present">Present</option>
        <option value="Absent">Absent</option>
      </select>

      <button id="mark-att" class="btn">Mark Attendance</button>
    </section>

    <section id="att-list" class="table-wrap"></section>
  </main>

  <footer>Â© 2025 EduConnect</footer>

  <script src="auth.js"></script>

  <script>
    function escapeHtml(s = '') {
      return String(s).replace(/[&<>"]/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
    }

    async function loadStudentsAndCourses() {
      try {
        const [uRes, cRes] = await Promise.all([
          authFetch('/api/auth/users'),
          authFetch('/api/courses')
        ]);

        const users = uRes && uRes.ok ? await uRes.json() : [];
        const courses = cRes && cRes.ok ? await cRes.json() : [];

        const studentSelect = document.getElementById('att-student');
        studentSelect.innerHTML = '';
        users
          .filter(u => u.role === 'student')
          .forEach(u => studentSelect.insertAdjacentHTML('beforeend',
            `<option value="${u.id}">${escapeHtml(u.name || u.email)}</option>`));

        const courseSelect = document.getElementById('att-course');
        courseSelect.innerHTML = '';
        courses.forEach(c => {
          const label = c.title || c.subject || c.name || `Course ${c.id}`;
          courseSelect.insertAdjacentHTML('beforeend',
            `<option value="${c.id}">${escapeHtml(label)}</option>`);
        });
      } catch (err) {
        // quietly ignore
      }
    }

    async function loadAttendance() {
  try {
    const res = await authFetch('/api/attendance');
    const data = res && res.ok ? await res.json() : [];
    const wrap = document.getElementById('att-list');

    if (!Array.isArray(data) || data.length === 0) {
      wrap.innerHTML = '<p>No attendance records found.</p>';
      return;
    }

    const isTeacherUser = typeof isTeacher === 'function' && isTeacher();

    wrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Student</th><th>Course</th><th>Date</th><th>Status</th>
            ${isTeacherUser ? '<th>Actions</th>' : ''}
          </tr>
        </thead>
        <tbody>
          ${data.map(r => `
            <tr data-id="${r.id}">
              <td>${escapeHtml(r.student_name || r.student || 'Unknown')}</td>
              <td>${escapeHtml(r.course_name || r.course || 'Unknown')}</td>
              <td>${escapeHtml(r.date)}</td>
              <td>${escapeHtml(r.status)}</td>
              ${isTeacherUser ? `
                <td>
                  <button class="edit-btn" data-id="${r.id}">Edit</button>
                  <button class="del-btn" data-id="${r.id}">Delete</button>
                </td>` : ''}
            </tr>`).join('')}
        </tbody>
      </table>`;

    if (isTeacherUser) {
      document.querySelectorAll('.del-btn').forEach(btn => btn.addEventListener('click', async e => {
        const id = e.target.dataset.id;
        if (!confirm('Delete this record?')) return;
        await authFetch(`/api/attendance/${id}`, { method: 'DELETE' });
        await loadAttendance();
      }));

      document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', async e => {
        const id = e.target.dataset.id;
        const row = e.target.closest('tr');
        const currentStatus = row.children[3].textContent.trim();
        const newStatus = prompt('Enter new status (Present/Absent):', currentStatus);
        if (!newStatus) return;

        await authFetch(`/api/attendance/${id}`, {
          method: 'PUT',
          body: JSON.stringify({ 
            user_id: row.children[0].textContent, 
            course_id: row.children[1].textContent,
            date: row.children[2].textContent, 
            status: newStatus 
          })
        });
        await loadAttendance();
      }));
    }

  } catch {
    document.getElementById('att-list').innerHTML = '<p>Failed to load attendance.</p>';
  }
}


    document.getElementById('mark-att').addEventListener('click', async () => {
      const user_id = document.getElementById('att-student').value;
      const course_id = document.getElementById('att-course').value;
      const date = document.getElementById('att-date').value || new Date().toISOString().slice(0,10);
      const status = document.getElementById('att-status').value;

      if (!user_id || !course_id || !date || !status) {
        alert('Please fill all fields.');
        return;
      }

      try {
        const res = await authFetch('/api/attendance', {
          method: 'POST',
          body: JSON.stringify({ user_id, course_id, date, status })
        });

        if (!res || !res.ok) return; // quietly fail

        await loadAttendance(); // refresh silently
      } catch {
        // quiet fail
      }
    });

    (async function init(){
      if (typeof applyRoleVisibility === 'function') applyRoleVisibility();
      if (typeof updateNavbarUser === 'function') updateNavbarUser();

      try { document.getElementById('att-date').value = new Date().toISOString().slice(0,10); } catch(e){}

      if (typeof isTeacher === 'function' && isTeacher()) {
        await loadStudentsAndCourses();
      } else {
        try { await authFetch('/api/courses'); } catch(e){}
      }

      await loadAttendance();
    })();
  </script>
</body>
</html>
